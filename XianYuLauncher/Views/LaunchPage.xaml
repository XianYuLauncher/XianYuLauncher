<Page
    x:Class="XianYuLauncher.Views.LaunchPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewModels="using:XianYuLauncher.ViewModels"
    xmlns:models="using:XianYuLauncher.Models"
    xmlns:animations="using:CommunityToolkit.WinUI.Animations"
    mc:Ignorable="d">

    <Page.Resources>
        <Style x:Key="SelectionRowStyle" TargetType="Button">
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Padding" Value="12,10" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>
    </Page.Resources>

    <Grid x:Name="ContentArea">
        <!-- 主内容 -->
        <ScrollViewer 
            VerticalScrollBarVisibility="Auto"
            HorizontalScrollBarVisibility="Disabled"
            Padding="40,36,40,24">
            
            <!-- 不使用 RepositionThemeTransition，改为给每个需要平移动画的 child 单独加 Implicit OffsetAnimation。
                 这样进度条（不加 OffsetAnimation）在 Collapsed→Visible 时不会飞入，
                 同时也彻底规避了 RepositionThemeTransition 在 Release 模式下对异步数据控件的概率性失效问题。 -->
            <StackPanel x:Name="MainContentPanel" Spacing="24" Width="420" HorizontalAlignment="Left">
                <!-- 页面标题 -->
                <StackPanel Spacing="4">
                    <animations:Implicit.Animations>
                        <animations:OffsetAnimation Duration="0:0:0.3" EasingMode="EaseOut" EasingType="Default" />
                    </animations:Implicit.Animations>
                    <TextBlock 
                        Text="{x:Bind ViewModel.PageTitle, Mode=OneWay}" 
                        FontSize="{x:Bind ViewModel.PageTitleFontSize, Mode=OneWay}"
                        Style="{StaticResource TitleTextBlockStyle}" 
                        FontWeight="SemiBold" />
                    <TextBlock 
                        Text="XianYu Launcher" 
                        Style="{StaticResource CaptionTextBlockStyle}" 
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                </StackPanel>

                <!-- 选择卡片 -->
                <Border 
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="4">
                    <animations:Implicit.Animations>
                        <animations:OffsetAnimation Duration="0:0:0.3" EasingMode="EaseOut" EasingType="Default" />
                    </animations:Implicit.Animations>
                    <StackPanel>
                        <!-- 版本选择行 -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <Button 
                                x:Name="VersionButton"
                                Style="{StaticResource SelectionRowStyle}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Border 
                                        Grid.Column="0"
                                        Width="32" Height="32"
                                        CornerRadius="6"
                                        Background="{ThemeResource AccentFillColorDefaultBrush}">
                                        <FontIcon 
                                            FontFamily="{StaticResource SymbolThemeFontFamily}" 
                                            Glyph="&#xE7FC;" 
                                            FontSize="14"
                                            Foreground="White" />
                                    </Border>
                                    <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                                        <TextBlock 
                                            Text="{x:Bind ViewModel.SelectedVersionDisplay, Mode=OneWay}"
                                            Style="{StaticResource BodyTextBlockStyle}"
                                            TextTrimming="CharacterEllipsis" />
                                        <TextBlock 
                                            x:Uid="LaunchPage_VersionSelection"
                                            Text="游戏版本"
                                            Style="{StaticResource CaptionTextBlockStyle}"
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                    </StackPanel>
                                    <FontIcon 
                                        Grid.Column="2"
                                        FontFamily="{StaticResource SymbolThemeFontFamily}" 
                                        Glyph="&#xE70D;" 
                                        FontSize="12"
                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                </Grid>
                                <Button.Flyout>
                                    <MenuFlyout x:Name="VersionMenuFlyout" Opening="VersionMenuFlyout_Opening">
                                        <MenuFlyoutSeparator />
                                        <MenuFlyoutItem 
                                            x:Uid="LaunchPage_AddVersion"
                                            Text="添加版本"
                                            Click="AddVersionMenuItem_Click">
                                            <MenuFlyoutItem.Icon>
                                                <SymbolIcon Symbol="Add" />
                                            </MenuFlyoutItem.Icon>
                                        </MenuFlyoutItem>
                                    </MenuFlyout>
                                </Button.Flyout>
                            </Button>
                            <Button 
                                Grid.Column="1"
                                Command="{x:Bind ViewModel.LoadInstalledVersionsCommand}"
                                Style="{StaticResource SubtleButtonStyle}"
                                Padding="8"
                                Margin="0,0,4,0"
                                CornerRadius="4"
                                VerticalAlignment="Center"
                                x:Uid="LaunchPage_RefreshVersionsTooltip"
                                ToolTipService.ToolTip="刷新版本列表">
                                <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="&#xe72c;" FontSize="12" />
                            </Button>
                        </Grid>

                        <!-- 分隔线 -->
                        <Border Height="1" Background="{ThemeResource DividerStrokeColorDefaultBrush}" Margin="12,0" Opacity="0.5" />

                        <!-- 角色选择行 -->
                        <Button 
                            x:Name="ProfileButton"
                            Style="{StaticResource SelectionRowStyle}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Border 
                                    Grid.Column="0"
                                    Width="32" Height="32"
                                    CornerRadius="6"
                                    Background="{ThemeResource ControlFillColorSecondaryBrush}">
                                    <Image 
                                        x:Name="ProfileAvatar"
                                        Width="32" Height="32"
                                        Source="ms-appx:///Assets/Icons/Avatars/Steve.png"
                                        Stretch="UniformToFill" />
                                </Border>
                                <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                                    <TextBlock 
                                        Text="{x:Bind ViewModel.SelectedProfileDisplay, Mode=OneWay}"
                                        Style="{StaticResource BodyTextBlockStyle}"
                                        TextTrimming="CharacterEllipsis" />
                                    <TextBlock 
                                        x:Uid="LaunchPage_PlayerName"
                                        Text="游戏角色"
                                        Style="{StaticResource CaptionTextBlockStyle}"
                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                </StackPanel>
                                <FontIcon 
                                    Grid.Column="2"
                                    FontFamily="{StaticResource SymbolThemeFontFamily}" 
                                    Glyph="&#xE70D;" 
                                    FontSize="12"
                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                            </Grid>
                            <Button.Flyout>
                                <MenuFlyout x:Name="ProfileMenuFlyout" Opening="ProfileMenuFlyout_Opening">
                                    <MenuFlyoutItem 
                                        x:Uid="LaunchPage_AddProfile"
                                        Text="添加角色"
                                        Click="AddProfileMenuItem_Click">
                                        <MenuFlyoutItem.Icon>
                                            <SymbolIcon Symbol="Add" />
                                        </MenuFlyoutItem.Icon>
                                    </MenuFlyoutItem>
                                </MenuFlyout>
                            </Button.Flyout>
                        </Button>
                    </StackPanel>
                </Border>

                <!-- 新闻/公告卡片 -->
                <Border 
                    x:Name="NewsCard"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="16">
                    <animations:Implicit.Animations>
                        <animations:OffsetAnimation Duration="0:0:0.3" EasingMode="EaseOut" EasingType="Default" />
                    </animations:Implicit.Animations>
                    <StackPanel Spacing="12">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock 
                                x:Uid="LaunchPage_NewsAndAnnouncements"
                                Text="新闻与公告"
                                Style="{StaticResource BodyStrongTextBlockStyle}" />
                            <HyperlinkButton 
                                Grid.Column="1"
                                x:Uid="LaunchPage_ViewMore"
                                Content="查看更多"
                                Padding="0"
                                FontSize="12"
                                Click="ViewMoreNews_Click" />
                        </Grid>
                        
                        <!-- 新闻列表（动态，最多展示3条） -->
                        <ItemsControl ItemsSource="{x:Bind ViewModel.NewsCardItems, Mode=OneWay}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Spacing="8" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="models:LaunchNewsCardDisplayItem">
                                    <Grid
                                        Background="Transparent"
                                        Tapped="NewsCardItem_Tapped"
                                        Tag="{Binding}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <Grid
                                            Width="6"
                                            Height="6"
                                            VerticalAlignment="Center"
                                            Margin="0,0,10,0">
                                            <Border
                                                Width="6"
                                                Height="6"
                                                CornerRadius="3"
                                                Background="{ThemeResource AccentFillColorDefaultBrush}"
                                                Visibility="{x:Bind IsPrimaryDot, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}" />
                                            <Border
                                                Width="6"
                                                Height="6"
                                                CornerRadius="3"
                                                Background="{ThemeResource TextFillColorSecondaryBrush}"
                                                Visibility="{x:Bind IsPrimaryDot, Mode=OneWay, Converter={StaticResource BoolToVisibilityInverseConverter}}" />
                                        </Grid>
                                        <TextBlock
                                            Grid.Column="1"
                                            Text="{x:Bind DisplayText, Mode=OneWay}"
                                            Style="{StaticResource CaptionTextBlockStyle}"
                                            TextTrimming="CharacterEllipsis" />
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- 启动按钮 -->
                <Button 
                    x:Name="LaunchButton"
                    x:Uid="LaunchPage_LaunchGame"
                    Style="{StaticResource AccentButtonStyle}"
                    Command="{x:Bind ViewModel.LaunchGameCommand}"
                    IsEnabled="{x:Bind ViewModel.SelectedVersion, Converter={StaticResource StringNullOrEmptyToBoolConverter}, Mode=OneWay}"
                    HorizontalAlignment="Stretch" 
                    Height="44"
                    CornerRadius="6">
                    <animations:Implicit.Animations>
                        <animations:OffsetAnimation Duration="0:0:0.3" EasingMode="EaseOut" EasingType="Default" />
                    </animations:Implicit.Animations>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon 
                            FontFamily="{StaticResource SymbolThemeFontFamily}" 
                            Glyph="&#xE768;" 
                            FontSize="16" />
                        <TextBlock 
                            Text="启动游戏" 
                            FontSize="14"
                            FontWeight="SemiBold"
                            VerticalAlignment="Center" />
                    </StackPanel>
                </Button>

                <!-- 进度状态 -->
                <StackPanel 
                    Spacing="6"
                    Visibility="{x:Bind ViewModel.DownloadProgress, Mode=OneWay, Converter={StaticResource ProgressVisibilityConverter}}">
                    <ProgressBar 
                        x:Name="DownloadProgressBar"
                        Value="{x:Bind ViewModel.DownloadProgress, Mode=OneWay}"
                        Minimum="0"
                        Maximum="100"
                        Height="4"
                        CornerRadius="2" />
                    <TextBlock 
                        x:Name="StatusTextBlock"
                        Text="{x:Bind ViewModel.LaunchStatus, Mode=OneWay}"
                        Style="{StaticResource CaptionTextBlockStyle}"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        TextTrimming="CharacterEllipsis" />
                </StackPanel>
            </StackPanel>
        </ScrollViewer>

        <TeachingTip
            x:Name="ActivityNewsTeachingTip"
            Target="{Binding ElementName=NewsCard}"
            Title="{x:Bind ViewModel.NewsTeachingTipTitle, Mode=OneWay}"
            IsOpen="{x:Bind ViewModel.IsNewsTeachingTipOpen, Mode=TwoWay}"
            PreferredPlacement="RightTop"
            IsLightDismissEnabled="True"
            CloseButtonClick="ActivityNewsTeachingTip_CloseButtonClick">
            <TeachingTip.Content>
                <StackPanel Spacing="10" MinWidth="320">
                    <Border
                        Visibility="{x:Bind ViewModel.IsNewsTeachingTipImageVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                        CornerRadius="8"
                        BorderThickness="1"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
                        <Image
                            Source="{x:Bind ViewModel.NewsTeachingTipImageSource, Mode=OneWay}"
                            Height="140"
                            Stretch="UniformToFill" />
                    </Border>
                    <TextBlock
                        Text="{x:Bind ViewModel.NewsTeachingTipSummary, Mode=OneWay}"
                        TextWrapping="Wrap"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                    <HyperlinkButton
                        Content="在浏览器中查看详情"
                        Command="{x:Bind ViewModel.OpenNewsTeachingTipLinkCommand}"
                        HorizontalAlignment="Left">
                        <HyperlinkButton.ContentTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <TextBlock Text="{Binding}" />
                                    <FontIcon
                                        FontFamily="{StaticResource SymbolThemeFontFamily}"
                                        Glyph="&#xE8A7;"
                                        FontSize="12"
                                        VerticalAlignment="Center" />
                                </StackPanel>
                            </DataTemplate>
                        </HyperlinkButton.ContentTemplate>
                    </HyperlinkButton>
                </StackPanel>
            </TeachingTip.Content>
        </TeachingTip>

        <!-- 开发版警告 (浮动在底部) -->
        <InfoBar
            x:Name="DevBuildInfoBar"
            IsOpen="{x:Bind ViewModel.IsDevBuild, Mode=OneWay}"
            Severity="Warning"
            Title="开发版"
            Message="可能不稳定，遇到问题请向开发人员反馈。"
            IsClosable="False"
            VerticalAlignment="Bottom"
            Margin="20,0,20,20"
            CornerRadius="8" />

        <!-- InfoBar 浮动在底部 -->
        <InfoBar 
            x:Name="LaunchSuccessInfoBar"
            x:Uid="LaunchPage_SuccessTitle"
            Title="游戏启动成功"
            Message="{x:Bind ViewModel.LaunchSuccessMessage, Mode=OneWay}"
            IsOpen="{x:Bind ViewModel.IsInfoBarOpen, Mode=OneWay}"
            Visibility="{x:Bind ViewModel.IsInfoBarOpen, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
            VerticalAlignment="Bottom"
            Margin="20,0,20,20"
            CornerRadius="8"
            Closed="LaunchSuccessInfoBar_Closed">
            <InfoBar.ActionButton>
                <Button 
                    x:Uid="LaunchPage_ViewLogsButton"
                    ToolTipService.ToolTip="查看日志"
                    Command="{x:Bind ViewModel.ViewLogsCommand}"
                    Visibility="{x:Bind ViewModel.IsViewLogsButtonVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                    Style="{StaticResource SubtleButtonStyle}"
                    Width="40"
                    Height="40"
                    Padding="0"
                    Margin="0,-4,-8,0"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Center">
                    <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="&#xE8A7;" FontSize="16" />
                </Button>
            </InfoBar.ActionButton>
        </InfoBar>
    </Grid>
</Page>
