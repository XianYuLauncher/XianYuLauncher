<Page
        x:Class="XianYuLauncher.Views.CharacterManagementPage"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:viewModels="using:XianYuLauncher.ViewModels"
        xmlns:helpers="using:XianYuLauncher.Helpers"
        xmlns:local="using:XianYuLauncher.ViewModels"
        mc:Ignorable="d">
        <Page.Resources>
            <helpers:BoolNegationConverter x:Key="BoolNegationConverter" />
            <helpers:StringEqualsConverter x:Key="StringEqualsConverter" />
        </Page.Resources>

    <Grid x:Name="ContentArea" Padding="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- 固定悬浮条 -->
        <Border
            Grid.Row="0"
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            CornerRadius="8"
            Padding="20"
            Margin="0,0,0,20">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                
                <!-- 角色图标 -->
                <Border
                    Grid.Column="0"
                    Width="48"
                    Height="48"
                    CornerRadius="24"
                    Background="#E5E7EB"
                    VerticalAlignment="Center">
                    <Image
                        x:Name="ProfileAvatar"
                        Width="48"
                        Height="48"
                        Source="ms-appx:///Assets/DefaultAvatar.png"
                        Stretch="Fill"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center" />
                </Border>
                
                <!-- 角色名称 -->
                <StackPanel
                    Grid.Column="1"
                    Orientation="Vertical"
                    Margin="16,0,0,0"
                    VerticalAlignment="Center">
                    <TextBlock
                        x:Uid="ProfileManagementPage_CurrentProfileLabel"
                        Text="当前角色"
                        Style="{StaticResource CaptionTextBlockStyle}"
                        Foreground="{ThemeResource TextFillColorSecondary}" />
                    <TextBlock
                        Text="{x:Bind ViewModel.CurrentProfile.Name, Mode=OneWay}"
                        Style="{StaticResource TitleTextBlockStyle}"
                        Foreground="{ThemeResource TextFillColorPrimary}" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- 功能选项区域 -->
        <ScrollViewer
            Grid.Row="1"
            VerticalScrollBarVisibility="Auto"
            HorizontalScrollBarVisibility="Disabled">
            <StackPanel Spacing="20">
                <!-- 皮肤3D预览卡片 -->
                <Border
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="20">
                    <StackPanel Spacing="16">
                        <StackPanel Spacing="8">
                            <TextBlock
                                x:Uid="ProfileManagementPage_Skin3DPreviewTitle"
                                Text="皮肤3D预览"
                                Style="{StaticResource TitleTextBlockStyle}"
                                FontSize="18"
                                FontWeight="SemiBold" />
                            <TextBlock
                                x:Uid="ProfileManagementPage_Skin3DPreviewNote"
                                Text="3D皮肤模型预览，支持旋转和缩放"
                                Style="{StaticResource CaptionTextBlockStyle}"
                                Foreground="{ThemeResource TextFillColorSecondary}" />
                        </StackPanel>
                        
                        <!-- 3D预览区域 -->
                        <Border
                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Height="350"
                            Width="Auto"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch">
                            <WebView2
                                x:Name="Skin3DPreviewWebView"
                                Source="ms-appx:///Assets/Skin3DPreview.html"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"
                                NavigationStarting="Skin3DPreviewWebView_NavigationStarting"
                                NavigationCompleted="Skin3DPreviewWebView_NavigationCompleted" />
                        </Border>
                    </StackPanel>
                </Border>
                
                <!-- 改名功能卡片 -->
                <Border
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="20">
                    <StackPanel Spacing="16">
                        <StackPanel Spacing="8">
                            <TextBlock
                                x:Uid="ProfileManagementPage_RenameTitle"
                                Text="改名"
                                Style="{StaticResource TitleTextBlockStyle}"
                                FontSize="18"
                                FontWeight="SemiBold" />
                            <TextBlock
                                x:Uid="ProfileManagementPage_OfflineOnlyNote"
                                Text="仅对离线角色启用"
                                Style="{StaticResource CaptionTextBlockStyle}"
                                Foreground="{ThemeResource TextFillColorSecondary}" />
                        </StackPanel>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            
                            <TextBox
                                x:Uid="ProfileManagementPage_NewUsernameTextBox"
                                Grid.Column="0"
                                Text="{x:Bind ViewModel.NewUsername, Mode=TwoWay}"
                                PlaceholderText="输入新用户名"
                                IsEnabled="{x:Bind ViewModel.CurrentProfile.IsOffline, Mode=OneWay}"
                                Margin="0,0,12,0" />
                            
                            <Button
                                x:Uid="ProfileManagementPage_SaveUsernameButton"
                                Grid.Column="1"
                                Content="保存"
                                Command="{x:Bind ViewModel.SaveUsernameCommand}"
                                IsEnabled="{x:Bind ViewModel.CurrentProfile.IsOffline, Mode=OneWay}" />
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- 修改UUID功能卡片 -->
                <Border
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="20">
                    <StackPanel Spacing="16">
                        <StackPanel Spacing="8">
                            <TextBlock
                                x:Uid="ProfileManagementPage_ChangeUuidTitle"
                                Text="修改UUID"
                                Style="{StaticResource TitleTextBlockStyle}"
                                FontSize="18"
                                FontWeight="SemiBold" />
                            <TextBlock
                                x:Uid="ProfileManagementPage_OfflineOnlyNote"
                                Text="仅对离线角色启用"
                                Style="{StaticResource CaptionTextBlockStyle}"
                                Foreground="{ThemeResource TextFillColorSecondary}" />
                        </StackPanel>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            
                            <TextBox
                                x:Uid="ProfileManagementPage_NewUuidTextBox"
                                Grid.Column="0"
                                Text="{x:Bind ViewModel.NewUUID, Mode=TwoWay}"
                                PlaceholderText="输入新UUID"
                                IsEnabled="{x:Bind ViewModel.CurrentProfile.IsOffline, Mode=OneWay}"
                                Margin="0,0,12,0" />
                            
                            <Button
                                x:Uid="ProfileManagementPage_SaveUuidButton"
                                Grid.Column="1"
                                Content="保存"
                                Command="{x:Bind ViewModel.SaveUUIDCommand}"
                                IsEnabled="{x:Bind ViewModel.CurrentProfile.IsOffline, Mode=OneWay}" />
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- 设置皮肤功能卡片 -->
                <Border
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="20">
                    <StackPanel Spacing="16">
                        <TextBlock
                            x:Uid="ProfileManagementPage_SetSkinTitle"
                            Text="设置皮肤"
                            Style="{StaticResource TitleTextBlockStyle}"
                            FontSize="18"
                            FontWeight="SemiBold" />
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="160" />
                            </Grid.ColumnDefinitions>
                            
                            <!-- 左侧：皮肤上传区域，保持居左 -->
                            <StackPanel Grid.Column="0" Spacing="12">
                                <TextBlock
                                    x:Uid="ProfileManagementPage_SkinUploadNote"
                                    Text="上传或选择新皮肤"
                                    Style="{StaticResource BodyTextBlockStyle}"
                                    Foreground="{ThemeResource TextFillColorSecondary}" />
                                
                                <Button
                                    x:Uid="ProfileManagementPage_BrowseSkinButton"
                                    Content="浏览皮肤文件"
                                    Click="BrowseSkinFileButton_Click"
                                    IsEnabled="{x:Bind ViewModel.CurrentProfile.IsOffline, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}" />
                            </StackPanel>
                            
                            <!-- 右侧：皮肤预览区域，在按钮文字右边一点 -->
                            <Image
                                x:Name="SkinTextureImage"
                                Grid.Column="1"
                                Source="{x:Bind ViewModel.CurrentSkinTexture, Mode=OneWay}"
                                Width="128"
                                Height="128"
                                Stretch="Uniform"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                PointerPressed="SkinTextureImage_PointerPressed" />
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- 披风功能卡片容器 - 包含两个不同类型的披风卡片 -->
                <StackPanel>
                    <!-- 设置披风功能卡片 - 仅微软账号可见 -->
                    <Border
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="20"
                        Visibility="{x:Bind ViewModel.CurrentProfile.TokenType, Mode=OneWay, Converter={StaticResource StringEqualsConverter}, ConverterParameter=Bearer}">
                        <StackPanel Spacing="16">
                            <TextBlock
                                x:Uid="ProfileManagementPage_SetCapeTitle"
                                Text="设置披风"
                                Style="{StaticResource TitleTextBlockStyle}"
                                FontSize="18"
                                FontWeight="SemiBold" />
                            
                            <StackPanel Spacing="12">
                                <TextBlock
                                    x:Uid="ProfileManagementPage_CapeSelectionNote"
                                    Text="选择当前账号的披风"
                                    Style="{StaticResource BodyTextBlockStyle}"
                                    Foreground="{ThemeResource TextFillColorSecondary}" />
                                
                                <ComboBox
                                    x:Uid="ProfileManagementPage_CapeComboBox"
                                    x:Name="CapeComboBox"
                                    ItemsSource="{x:Bind ViewModel.CapeList, Mode=OneWay}"
                                    SelectedItem="{x:Bind ViewModel.SelectedCape, Mode=TwoWay}"
                                    IsEnabled="{x:Bind ViewModel.IsCapeSelectionEnabled, Mode=OneWay}"
                                    PlaceholderText="选择披风">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                                <!-- 披风图标 -->
                                                <Image
                                                    Source="{Binding Icon}"
                                                    Width="10"
                                                    Height="16"
                                                    Stretch="Uniform"
                                                    VerticalAlignment="Center"/>
                                                <!-- 披风名称 -->
                                                <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                
                                <Button
                                    x:Uid="ProfileManagementPage_ApplyCapeButton"
                                    Content="应用所选披风"
                                    Command="{x:Bind ViewModel.SetCapeCommand}"
                                    IsEnabled="{x:Bind ViewModel.IsCapeApplyEnabled, Mode=OneWay}" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- 设置披风功能卡片 - 仅外置登录账号可见 -->
                    <Border
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="20"
                        Visibility="{x:Bind ViewModel.CurrentProfile.TokenType, Mode=OneWay, Converter={StaticResource StringEqualsConverter}, ConverterParameter=external}">
                        <StackPanel Spacing="16">
                            <TextBlock
                                x:Uid="ProfileManagementPage_SetCapeTitle"
                                Text="设置披风"
                                Style="{StaticResource TitleTextBlockStyle}"
                                FontSize="18"
                                FontWeight="SemiBold" />
                            
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="160" />
                                </Grid.ColumnDefinitions>
                                
                                <!-- 左侧：披风上传区域，保持居左 -->
                                <StackPanel Grid.Column="0" Spacing="12">
                                    <TextBlock
                                        x:Uid="ProfileManagementPage_CapeUploadNote"
                                        Text="上传或选择新披风"
                                        Style="{StaticResource BodyTextBlockStyle}"
                                        Foreground="{ThemeResource TextFillColorSecondary}" />
                                    
                                    <Button
                                        x:Uid="ProfileManagementPage_BrowseCapeButton"
                                        Content="浏览披风文件"
                                        Click="BrowseCapeFileButton_Click"
                                        IsEnabled="False" />
                                </StackPanel>
                                
                                <!-- 右侧：披风预览区域，在按钮文字右边一点 -->
                                <Image
                                    x:Name="CapeTextureImage"
                                    Grid.Column="1"
                                    Source="{x:Bind ViewModel.CurrentCapeTexture, Mode=OneWay}"
                                    Width="128"
                                    Height="128"
                                    Stretch="Uniform"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Top" 
                                    PointerPressed="CapeTextureImage_PointerPressed" />
                            </Grid>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>
        
        <!-- 皮肤信息TeachingTip - 移到ScrollViewer之外，避免Content多次设置错误 -->
        <TeachingTip
            x:Uid="ProfileManagementPage_SkinTeachingTip"
            x:Name="SkinTeachingTip"
            Title="皮肤信息"
            Subtitle="当前皮肤的详细信息"
            Target="{x:Bind SkinTextureImage}">
            <StackPanel Spacing="8">
                <TextBlock x:Uid="ProfileManagementPage_SkinModelLabel" Text="适用的模型:" />
                <TextBlock Text="{x:Bind ViewModel.CurrentSkinModel, Mode=OneWay}" />
                <Button
                    x:Uid="ProfileManagementPage_SaveSkinButton"
                    Content="保存皮肤纹理"
                    Click="SaveSkinTextureButton_Click" />
            </StackPanel>
        </TeachingTip>
    </Grid>
</Page>