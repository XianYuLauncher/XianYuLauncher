<Page
    x:Class="XianYuLauncher.Views.FixerChatPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:viewModels="using:XianYuLauncher.ViewModels"
    xmlns:ct="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid Padding="20" Background="Transparent">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 标题栏 -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="0,0,0,12">
            <FontIcon Glyph="&#xE946;" FontSize="18" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
            <TextBlock Text="XianYu Fixer" FontSize="18" FontWeight="SemiBold" VerticalAlignment="Center" />
        </StackPanel>

        <!-- 聊天消息列表 -->
        <ListView 
            Grid.Row="1"
            ItemsSource="{x:Bind ViewModel.ChatMessages}"
            SelectionMode="None"
            IsItemClickEnabled="False"
            x:Name="ChatListView">
            <ListView.ItemTemplate>
                <DataTemplate x:DataType="viewModels:UiChatMessage">
                    <Grid Margin="0,8">
                        <StackPanel Spacing="4">
                            <TextBlock Text="{x:Bind Role, Mode=OneWay}" FontWeight="Bold" FontSize="12" Opacity="0.6" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            <TextBlock 
                                Text="{x:Bind Content, Mode=OneWay}" 
                                TextWrapping="Wrap" 
                                FontSize="14"
                                Foreground="{ThemeResource TextFillColorPrimaryBrush}" 
                                IsTextSelectionEnabled="True" 
                                Visibility="{x:Bind IsUser, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            <ct:MarkdownTextBlock 
                                Text="{x:Bind Content, Mode=OneWay}" 
                                Background="Transparent" 
                                TextWrapping="Wrap" 
                                FontSize="14"
                                Foreground="{ThemeResource TextFillColorPrimaryBrush}" 
                                IsTextSelectionEnabled="True" 
                                Visibility="{x:Bind IsAssistant, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        </StackPanel>
                    </Grid>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>

        <!-- 智能修复操作区域 -->
        <StackPanel Grid.Row="2" Margin="0,12,0,0" Spacing="8">
            <Grid
                Visibility="{x:Bind ViewModel.HasFixAction, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Button
                    Grid.Column="0"
                    Command="{x:Bind ViewModel.FixErrorCommand}"
                    HorizontalAlignment="Stretch"
                    Padding="12,8"
                    CornerRadius="4"
                    Style="{StaticResource AccentButtonStyle}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <FontIcon Glyph="&#xE73E;" FontSize="16" Foreground="White" Margin="0,0,12,0" />
                        <TextBlock 
                            Grid.Column="1" 
                            Text="{x:Bind ViewModel.FixButtonText, Mode=OneWay}" 
                            Foreground="White" 
                            FontWeight="SemiBold"
                            TextTrimming="CharacterEllipsis"/>
                        <FontIcon Grid.Column="2" Glyph="&#xE76C;" FontSize="12" Foreground="White" Opacity="0.8" />
                    </Grid>
                </Button>
                <Button
                    Grid.Column="1"
                    Command="{x:Bind ViewModel.RejectFixActionCommand}"
                    Padding="12,8"
                    CornerRadius="4"
                    Style="{StaticResource DefaultButtonStyle}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="&#xE711;" FontSize="14" />
                        <TextBlock Text="拒绝" />
                    </StackPanel>
                </Button>
            </Grid>
            <Button
                Command="{x:Bind ViewModel.FixErrorSecondaryCommand}"
                Visibility="{x:Bind ViewModel.HasSecondaryFixAction, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                HorizontalAlignment="Stretch"
                Padding="12,8"
                CornerRadius="4">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <FontIcon Glyph="&#xE74D;" FontSize="16" Margin="0,0,12,0" />
                    <TextBlock 
                        Grid.Column="1" 
                        Text="{x:Bind ViewModel.SecondaryFixButtonText, Mode=OneWay}" 
                        FontWeight="SemiBold"
                        TextTrimming="CharacterEllipsis"/>
                    <FontIcon Grid.Column="2" Glyph="&#xE76C;" FontSize="12" Opacity="0.8" />
                </Grid>
            </Button>
        </StackPanel>

        <!-- 输入区域 -->
        <Grid Grid.Row="3" Margin="0,12,0,0" ColumnSpacing="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <TextBox x:Name="ChatInputBox"
                     Text="{x:Bind ViewModel.ChatInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                     PlaceholderText="Ask a follow-up question..." 
                     IsEnabled="{x:Bind ViewModel.IsChatEnabled, Mode=OneWay}"
                     KeyDown="ChatInput_KeyDown"/> 
            <Button Grid.Column="1" Command="{x:Bind ViewModel.SendMessageCommand}" Style="{StaticResource DefaultButtonStyle}" IsEnabled="{x:Bind ViewModel.IsChatEnabled, Mode=OneWay}">
                <FontIcon Glyph="&#xE725;" />
            </Button>
        </Grid>
    </Grid>
</Page>
