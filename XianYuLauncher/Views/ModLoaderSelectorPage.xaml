<Page
    x:Class="XianYuLauncher.Views.ModLoaderSelectorPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewModels="using:XianYuLauncher.ViewModels"
    xmlns:helpers="using:XianYuLauncher.Helpers"
    xmlns:core="using:XianYuLauncher.Core.Models"
    xmlns:services="using:XianYuLauncher.Core.Services"
    mc:Ignorable="d"
    HorizontalAlignment="Stretch">

    <Page.Resources>
        <helpers:StringNullOrEmptyToBoolConverter x:Key="StringNullOrEmptyToBoolConverter" />
        <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <helpers:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
        <helpers:BoolToFontWeightConverter x:Key="BoolToFontWeightConverter" />
        <helpers:BoolToBrushConverter x:Key="BoolToBrushConverter" />
        <helpers:ModLoaderToIconConverter x:Key="ModLoaderToIconConverter" />
    </Page.Resources>

    <Grid x:Name="ContentArea" Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 页面标题 -->
        <StackPanel Grid.Row="0" Margin="0,0,0,24">
            <TextBlock x:Uid="ModLoaderSelectionPage_TitleText" Text="下载Minecraft" FontSize="28" FontWeight="Bold" />
            <TextBlock Margin="0,8,0,0" FontSize="16">
                <Run x:Uid="ModLoaderSelectionPage_CurrentVersionText" Text="当前Minecraft版本: " />
                <Run Text="{x:Bind ViewModel.SelectedMinecraftVersion, Mode=OneWay}" FontWeight="SemiBold" />
            </TextBlock>
        </StackPanel>

        <!-- 版本名称编辑卡片 -->
        <Grid Grid.Row="1" Margin="0,0,0,24">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            <TextBlock x:Uid="ModLoaderSelectionPage_VersionNameText" Text="版本名称:" Margin="0,0,0,12" FontWeight="SemiBold" FontSize="16" />
            <Border 
                Grid.Row="1"
                Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="16">
                <StackPanel>
                    <TextBlock x:Uid="ModLoaderSelectionPage_VersionNameDescription" Text="自定义版本名称，下载时将使用此名称创建版本文件夹、jar文件和json文件。" 
                               FontSize="14"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               Margin="0,0,0,8" />
                    <TextBox 
                        x:Uid="ModLoaderSelectionPage_VersionNameTextBox"
                        Text="{x:Bind ViewModel.VersionName, Mode=TwoWay}"
                        PlaceholderText="例如: 1.21.10-fabric-0.15.3"
                        FontSize="16"
                        Padding="12"
                        Background="{ThemeResource TextControlBackground}"
                        BorderBrush="{ThemeResource TextControlBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="4" />
                </StackPanel>
            </Border>
        </Grid>

        <!-- Mod Loader选择区域 -->
        <Grid Grid.Row="2" Margin="0,0,0,24">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <TextBlock x:Uid="ModLoaderSelectionPage_SelectComponentsText" Text="选择附属组件:" Margin="0,0,0,16" FontWeight="SemiBold" FontSize="16" />
            
            <!-- Mod Loader Expander列表 -->
            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalAlignment="Stretch">
                <Grid HorizontalAlignment="Stretch">
                    <!-- 每个Mod Loader作为一个Expander -->
                    <ItemsRepeater ItemsSource="{x:Bind ViewModel.ModLoaderItems, Mode=OneWay}" 
                                  HorizontalAlignment="Stretch">
                        <ItemsRepeater.Layout>
                            <StackLayout Spacing="12" />
                        </ItemsRepeater.Layout>
                        <ItemsRepeater.ItemTemplate>
                            <DataTemplate x:DataType="core:ModLoaderItem">
                                <Expander 
                                    x:Name="ModLoaderExpander"
                                    IsExpanded="{x:Bind IsSelected, Mode=TwoWay}" 
                                    BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Padding="0"
                                    RequestedTheme="Default"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Stretch">
                                    <Expander.Header>
                                        <!-- Expander头部，用于选择ModLoader -->
                                        <Grid 
                                            Padding="16,12" 
                                            CornerRadius="8 8 0 0"
                                            HorizontalAlignment="Stretch"
                                            DataContext="{x:Bind}">
                                            <Grid.Background>
                                                <SolidColorBrush Color="Transparent" />
                                            </Grid.Background>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <TextBlock 
                                                Grid.Column="0"
                                                Text="{x:Bind Name, Mode=OneWay}" 
                                                FontSize="16" 
                                                FontWeight="{x:Bind IsSelected, Mode=OneWay, Converter={StaticResource BoolToFontWeightConverter}}"
                                                VerticalAlignment="Center" 
                                                HorizontalAlignment="Stretch" />
                                            <Button
                                                x:Uid="ModLoaderSelectionPage_CancelSelectionButton"
                                                Grid.Column="1"
                                                Width="24"
                                                Height="24"
                                                Padding="0"
                                                Margin="-8,0,0,0"
                                                Background="Transparent"
                                                BorderBrush="Transparent"
                                                Foreground="{ThemeResource TextFillColorSecondary}"
                                                Click="CancelModLoader_Click"
                                                Tag="{Binding}"
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Center"
                                                Visibility="{x:Bind IsSelected, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                                ToolTipService.ToolTip="取消选择">
                                                <FontIcon Glyph="&#xE711;" FontSize="12" HorizontalAlignment="Center" VerticalAlignment="Center" />
                                            </Button>
                                            </Grid>
                                    </Expander.Header>
                                    
                                    <!-- Expander内容，包含版本列表和加载指示器 -->
                                    <Grid Padding="16,12" MinHeight="100" HorizontalAlignment="Stretch">
                                        <!-- 加载指示器 -->
                                        <ProgressRing
                                            IsActive="{x:Bind IsLoading, Mode=OneWay}"
                                            Visibility="{x:Bind IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Width="48"
                                            Height="48" />
                                        
                                        <!-- 版本列表 -->
                                        <ListView
                                            x:Name="ModLoaderListView"
                                            ItemsSource="{x:Bind Versions, Mode=OneWay}"
                                            SelectedItem="{x:Bind SelectedVersion, Mode=TwoWay}"
                                            SelectionMode="Single"
                                            Visibility="{x:Bind IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Stretch"
                                            MaxHeight="200"
                                            Width="Auto"
                                            Tag="{x:Bind Mode=OneWay}"> <!-- 将整个ModLoaderItem作为Tag -->
                                            <ListView.ItemTemplate>
                                                        <DataTemplate x:DataType="x:String">
                                                            <Grid HorizontalAlignment="Stretch">
                                                                <Border Padding="12,8" Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="6" Margin="0,4,0,4" HorizontalAlignment="Stretch">
                                                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch">
                                                                        <!-- ModLoader图标 -->
                                                                        <Image 
                                                                            Source="{Binding ElementName=ModLoaderListView, Path=Tag.IconUrl}" 
                                                                            Width="20" 
                                                                            Height="20" 
                                                                            Margin="0,0,12,0" 
                                                                            VerticalAlignment="Center"
                                                                            Stretch="UniformToFill" 
                                                                            Visibility="Visible"/>
                                                                                                                                    <!-- 内容区域，使用Grid布局，分为版本号和兼容信息两列 -->
                                                                        <Grid HorizontalAlignment="Stretch">
                                                                            <Grid.ColumnDefinitions>
                                                                                <ColumnDefinition Width="*" />
                                                                                <ColumnDefinition Width="Auto" />
                                                                            </Grid.ColumnDefinitions>
                                                                            
                                                                            <!-- 版本号 -->
                                                                            <TextBlock 
                                                                                Grid.Column="0" 
                                                                                Text="{x:Bind}" 
                                                                                FontSize="15" 
                                                                                VerticalAlignment="Center" 
                                                                                HorizontalAlignment="Left" />
                                                                            
                                                                            <!-- Optifine兼容信息 -->
                                                                            <TextBlock 
                                                                                Grid.Column="1" 
                                                                                FontSize="12" 
                                                                                Foreground="{ThemeResource TextFillColorSecondary}" 
                                                                                VerticalAlignment="Center" 
                                                                                HorizontalAlignment="Right" 
                                                                                Margin="8,0,0,0"
                                                                                Tag="{x:Bind}" 
                                                                                Loaded="CompatibleInfoTextBlock_Loaded">
                                                                            </TextBlock>
                                                                        </Grid>
                                                                    </StackPanel>
                                                                </Border>
                                                            </Grid>
                                                        </DataTemplate>
                                                    </ListView.ItemTemplate>

                                        </ListView>
                                    </Grid>
                                </Expander>
                            </DataTemplate>
                        </ItemsRepeater.ItemTemplate>
                    </ItemsRepeater>
                </Grid>
            </ScrollViewer>
        </Grid>

        <!-- 确认按钮 -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="12">
            <Button
                x:Uid="ModLoaderSelectionPage_CancelButton"
                Content="取消"
                Command="{x:Bind ViewModel.CancelCommand}"
                MinWidth="100" />
            <Button
                x:Uid="ModLoaderSelectionPage_ConfirmDownloadButton"
                Content="确认下载"
                Command="{x:Bind ViewModel.ConfirmSelectionCommand}"
                MinWidth="120" />
        </StackPanel>
        
        <!-- 下载进度弹窗 -->
        <ContentDialog
            x:Uid="ModLoaderSelectionPage_DownloadProgressDialog"
            x:Name="DownloadProgressDialog"
            IsPrimaryButtonEnabled="False"
            IsSecondaryButtonEnabled="False"
            DefaultButton="None"
            CloseButtonClick="DownloadProgressDialog_CloseButtonClick">
            <StackPanel Spacing="16" Width="400">
                <!-- 下载状态文本 -->
                <TextBlock FontSize="16" Text="{x:Bind ViewModel.DownloadStatus, Mode=OneWay}" TextWrapping="WrapWholeWords" />
                
                <!-- 进度条 -->
                <ProgressBar Value="{x:Bind ViewModel.DownloadProgress, Mode=OneWay}" Minimum="0" Maximum="100" Height="8" CornerRadius="4" />
                
                <!-- 进度百分比文本 -->
                <TextBlock FontSize="14" Foreground="{ThemeResource TextFillColorSecondary}" Text="{x:Bind ViewModel.DownloadProgressText, Mode=OneWay}" HorizontalTextAlignment="Center" />
            </StackPanel>
        </ContentDialog>
    </Grid>
</Page>