<Page
    x:Class="XMCL2025.Views.ModPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:helpers="using:XMCL2025.Helpers"
    xmlns:viewModels="using:XMCL2025.ViewModels"
    xmlns:models="using:XMCL2025.Core.Models"
    mc:Ignorable="d">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <StackPanel Grid.Row="0" Margin="20,20,20,0">
            <TextBlock Text="Mods" Style="{ThemeResource TitleTextBlockStyle}" />
            <TextBlock Text="Browse and download mods for Minecraft" Style="{ThemeResource BodyTextBlockStyle}" Opacity="0.7" />
        </StackPanel>

        <!-- Search and Filter Section -->
        <Grid Grid.Row="1" Margin="20,10,20,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Search Box -->
            <AutoSuggestBox
                x:Name="SearchBox"
                Grid.Row="0"
                Grid.Column="0"
                PlaceholderText="Search mods..."
                QueryIcon="Find"
                Margin="0,0,10,0"
                Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay}"
                QuerySubmitted="SearchBox_QuerySubmitted"/>

            <!-- Mod Loader Filter -->
            <ComboBox
                x:Name="LoaderComboBox"
                Grid.Row="0"
                Grid.Column="1"
                Header="加载器"
                PlaceholderText="加载器"
                Margin="0,0,10,0"
                MinWidth="120"
                SelectedValue="{x:Bind ViewModel.SelectedLoader, Mode=TwoWay}"
                SelectedValuePath="Tag"
                SelectionChanged="LoaderComboBox_SelectionChanged">
                <ComboBoxItem Content="All" Tag="all" IsSelected="True" />
                <ComboBoxItem Content="Fabric" Tag="fabric" />
                <ComboBoxItem Content="Forge" Tag="forge" />
                <ComboBoxItem Content="Quilt" Tag="quilt" />
                <ComboBoxItem Content="NeoForge" Tag="neoforge" />
            </ComboBox>

            <!-- Version Filter -->
            <ComboBox
                x:Name="VersionComboBox"
                Grid.Row="0"
                Grid.Column="2"
                Header="版本"
                PlaceholderText="版本"
                Margin="0,0,10,0"
                MinWidth="120"
                ItemsSource="{x:Bind ViewModel.AvailableVersions, Mode=OneWay}"
                SelectedItem="{x:Bind ViewModel.SelectedVersion, Mode=TwoWay}"
                SelectionChanged="VersionComboBox_SelectionChanged">
            </ComboBox>

            <!-- Sort By -->
            <ComboBox
                Grid.Row="0"
                Grid.Column="3"
                Header="Sort"
                PlaceholderText="Most Popular"
                MinWidth="120">
                <ComboBoxItem Content="Most Popular" IsSelected="True"/>
                <ComboBoxItem Content="Recently Updated"/>
                <ComboBoxItem Content="Most Downloads"/>
                <ComboBoxItem Content="Name A-Z"/>
            </ComboBox>
        </Grid>

        <!-- Error Message -->
        <Grid
            Grid.Row="2"
            Margin="20,10,20,10"
            Background="#FFFDE7E9"
            BorderBrush="#FFD53939"
            BorderThickness="1"
            CornerRadius="8"
            Padding="12"
            Visibility="{x:Bind ViewModel.ErrorMessage, Mode=OneWay, Converter={StaticResource StringNullOrEmptyToBoolConverter}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <TextBlock
                Grid.Column="0"
                Text="⚠"
                FontSize="24"
                VerticalAlignment="Center"
                Margin="0,0,12,0"
                Foreground="#FFD53939"/>
            <TextBlock
                Grid.Column="1"
                Text="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                Foreground="#FFD53939"
                Style="{ThemeResource BodyTextBlockStyle}"
                VerticalAlignment="Center"/>
        </Grid>

        <!-- Loading Indicator -->
        <ProgressRing
            Grid.Row="2"
            Margin="20"
            IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
            VerticalAlignment="Center"
            HorizontalAlignment="Center"
            Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}"/>

        <!-- Mod List Section -->
        <ScrollViewer
            x:Name="ModListScrollViewer"
            Grid.Row="2"
            Margin="20"
            VerticalScrollBarVisibility="Auto"
            ViewChanged="ModListScrollViewer_ScrollChanged">
            <ListView
                SelectionMode="Single"
                ItemsSource="{x:Bind ViewModel.ModList, Mode=OneWay}"
                Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
                <ListView.Resources>
                    <Style TargetType="ScrollViewer">
                        <Setter Property="HorizontalScrollBarVisibility" Value="Disabled"/>
                        <Setter Property="VerticalScrollBarVisibility" Value="Disabled"/>
                    </Style>
                </ListView.Resources>
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="Margin" Value="0,0,0,12"/>
                </Style>
            </ListView.ItemContainerStyle>
            
            <!-- Mod Item Template -->
            <ListView.ItemTemplate>
                <DataTemplate x:DataType="models:ModrinthProject">
                    <Grid Height="120" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                          CornerRadius="8" Padding="12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                          BorderThickness="1" Tapped="ModItem_Tapped">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Mod Icon -->
                        <Border Grid.Column="0" Grid.Row="0" Grid.RowSpan="3" Width="64" Height="64" Margin="0,0,12,0"
                                CornerRadius="32" Background="Transparent">
                            <Image Stretch="UniformToFill">
                                <Image.Source>
                                    <BitmapImage UriSource="{x:Bind IconUrl, Mode=OneWay}" DecodePixelWidth="64" DecodePixelHeight="64"/>
                                </Image.Source>
                            </Image>
                        </Border>

                        <!-- Mod Name -->
                        <TextBlock Grid.Column="1" Grid.Row="0" Text="{x:Bind Title, Mode=OneWay}"
                                   FontSize="16" FontWeight="SemiBold"/>

                        <!-- Mod Description -->
                        <TextBlock Grid.Column="1" Grid.Row="1" Text="{x:Bind Description, Mode=OneWay}"
                                   Style="{ThemeResource BodyTextBlockStyle}" Opacity="0.8" TextWrapping="WrapWholeWords"
                                   MaxLines="2" VerticalAlignment="Center"/>

                        <!-- Mod Info -->
                        <StackPanel Grid.Column="1" Grid.Row="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Bottom">
                            <TextBlock Text="{x:Bind SupportedLoaders, Mode=OneWay}" Style="{ThemeResource CaptionTextBlockStyle}" Opacity="0.7"/>
                            <TextBlock Text="{x:Bind LatestSupportedVersion, Mode=OneWay}" Style="{ThemeResource CaptionTextBlockStyle}" Opacity="0.7"/>
                            <TextBlock Text="{x:Bind Downloads, Mode=OneWay}" Style="{ThemeResource CaptionTextBlockStyle}" Opacity="0.7"/>
                            <TextBlock Text="{x:Bind Follows, Mode=OneWay}" Style="{ThemeResource CaptionTextBlockStyle}" Opacity="0.7"/>
                        </StackPanel>
                    </Grid>
                </DataTemplate>
            </ListView.ItemTemplate>
            <!-- Loading More Indicator -->
            <ListView.Footer>
                <ProgressRing 
                    IsActive="{x:Bind ViewModel.IsLoadingMore, Mode=OneWay}" 
                    Width="32" Height="32" 
                    Margin="0,10,0,10" 
                    HorizontalAlignment="Center"/>
            </ListView.Footer>
            </ListView>
        </ScrollViewer>



    </Grid>
</Page>