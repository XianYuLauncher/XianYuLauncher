name: Publish Release (123Pan & Gitee)

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag to deploy (e.g. v1.4.2)'
        required: true
        default: 'v1.4.2'
      full_version:
        description: 'Full version (e.g. 1.4.2.0). Leave empty to auto-append .0'
        required: false
        default: ''
      skip_123pan:
        description: 'Skip 123Pan upload (only sync Gitee with GitHub URLs)'
        required: false
        type: boolean
        default: false

jobs:
  sync_to_123pan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Compute Version
        id: vars
        shell: bash
        run: |
          TAG_NAME="${{ inputs.tag_name }}"
          VER_NUM="${TAG_NAME#v}"
          FULL_VER_INPUT="${{ inputs.full_version }}"
          if [ -z "$FULL_VER_INPUT" ]; then
            FULL_VER="${VER_NUM}.0"
          else
            FULL_VER="$FULL_VER_INPUT"
          fi
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "full_ver=$FULL_VER" >> $GITHUB_OUTPUT

      - name: Fetch Release Notes
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY=$(gh release view "${{ inputs.tag_name }}" --repo "${{ github.repository }}" --json body -q .body)
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download Release Assets from GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p release-assets
          FULL_VER="${{ steps.vars.outputs.full_ver }}"
          TAG="${{ steps.vars.outputs.tag }}"
          
          echo "Downloading assets for $TAG..."
          gh release download "$TAG" --repo "${{ github.repository }}" --dir release-assets
          
          cd release-assets
          # 重命名以便统一管理，方便脚本识别
          mv "XianYuLauncher_${FULL_VER}_x64.zip" "XianYuLauncher_${FULL_VER}_x64.zip" 2>/dev/null || true
          mv "XianYuLauncher_${FULL_VER}_x86.zip" "XianYuLauncher_${FULL_VER}_x86.zip" 2>/dev/null || true
          mv "XianYuLauncher_${FULL_VER}_arm64.zip" "XianYuLauncher_${FULL_VER}_arm64.zip" 2>/dev/null || true
          ls -lh

      - name: Install Python Dependencies
        run: pip install requests

      - name: Upload to 123Pan
        if: ${{ inputs.skip_123pan != true }}
        env:
          PAN123_CLIENT_ID: ${{ secrets.PAN123_CLIENT_ID }}
          PAN123_CLIENT_SECRET: ${{ secrets.PAN123_CLIENT_SECRET }}
        run: |
          echo "Starting upload to 123Pan..."
          # 遍历 release-assets 下的所有 zip 文件
          for file in release-assets/*.zip; do
            if [ -f "$file" ]; then
              echo "----------------------------------------"
              echo "Processing $file ..."
              python3 .github/scripts/upload_123pan.py \
                --file "$file" \
                --client_id "$PAN123_CLIENT_ID" \
                --client_secret "$PAN123_CLIENT_SECRET" \
                --parent_id "29037672" \
                --output_json "123pan_links.json"
            fi
          done

      - name: Sync Gitee latest_version.json
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          FULL_VER: ${{ steps.vars.outputs.full_ver }}
          TAG: ${{ steps.vars.outputs.tag }}
          CHANGELOG: ${{ steps.release.outputs.body }}
        run: |
          if [ -z "$GITEE_TOKEN" ]; then
            echo "GITEE_TOKEN is missing." >&2
            exit 1
          fi

          REPO="spiritos/XianYuLauncher-Resource"
          git clone "https://oauth2:${GITEE_TOKEN}@gitee.com/${REPO}.git" gitee-repo
          cd gitee-repo

          # Pass 123Pan links to the python script (may not exist if skipped)
          cp ../123pan_links.json . 2>/dev/null || echo '{}' > 123pan_links.json

          python3 << 'PYEOF'
          import json, os
          from datetime import datetime

          path = "latest_version.json"
          links_path = "123pan_links.json"
          
          # Read existing version file
          with open(path, "r", encoding="utf-8") as f:
              data = json.load(f)
              
          # Read 123Pan links
          links = {}
          if os.path.exists(links_path):
              with open(links_path, "r", encoding="utf-8") as f:
                  links = json.load(f)

          full_ver = os.environ.get("FULL_VER")
          tag = os.environ.get("TAG")
          changelog = os.environ.get("CHANGELOG", "")

          data["version"] = full_ver
          data["release_time"] = datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")

          if changelog:
              data["changelog"] = [line.strip() for line in changelog.split("\n") if line.strip()]
          
          # Helper to find link by arch
          def get_link(arch):
              # Filename format: XianYuLauncher_{full_ver}_{arch}.zip
              expected = f"XianYuLauncher_{full_ver}_{arch}.zip"
              return links.get(expected, "")

          # GitHub fallback URLs
          github_base = f"https://github.com/N123999/XianYuLauncher/releases/download/{tag}"

          mirrors = []
          
          pan_x64 = get_link("x64")
          if pan_x64:
              mirrors.append({
                  "name": "123Pan (Fast)",
                  "url": pan_x64,
                  "arch_urls": {
                      "x64": pan_x64,
                      "x86": get_link("x86"),
                      "arm64": get_link("arm64")
                  }
              })
          
          mirrors.append({
              "name": "GitHub",
              "url": f"{github_base}/XianYuLauncher_{full_ver}_x64.zip",
              "arch_urls": {
                  "x64": f"{github_base}/XianYuLauncher_{full_ver}_x64.zip",
                  "x86": f"{github_base}/XianYuLauncher_{full_ver}_x86.zip",
                  "arm64": f"{github_base}/XianYuLauncher_{full_ver}_arm64.zip"
              }
          })
          
          data["download_mirrors"] = mirrors

          with open(path, "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          
          print(f"Updated latest_version.json with version={full_ver}")
          PYEOF

          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add latest_version.json
          SKIP_PAN="${{ inputs.skip_123pan }}"
          if [ "$SKIP_PAN" = "true" ]; then
            git commit -m "chore: update version to $FULL_VER (GitHub only)" || echo "No changes"
          else
            git commit -m "chore: update version to $FULL_VER (123Pan + GitHub)" || echo "No changes"
          fi
          git push
