name: Sync to Gitee

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag to deploy (e.g. v1.4.2)'
        required: true
        default: 'v1.4.2'
      full_version:
        description: 'Full version (e.g. 1.4.2.0). Leave empty to auto-append .0'
        required: false
        default: ''

jobs:
  sync_to_gitee:
    runs-on: ubuntu-latest
    steps:
      - name: Compute Version
        id: vars
        shell: bash
        run: |
          TAG_NAME="${{ inputs.tag_name }}"
          VER_NUM="${TAG_NAME#v}"
          FULL_VER_INPUT="${{ inputs.full_version }}"
          if [ -z "$FULL_VER_INPUT" ]; then
            FULL_VER="${VER_NUM}.0"
          else
            FULL_VER="$FULL_VER_INPUT"
          fi
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "full_ver=$FULL_VER" >> $GITHUB_OUTPUT

      - name: Fetch Release Notes
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY=$(gh release view "${{ inputs.tag_name }}" --repo "${{ github.repository }}" --json body -q .body)
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download Release Assets from GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p release-assets
          FULL_VER="${{ steps.vars.outputs.full_ver }}"
          TAG="${{ steps.vars.outputs.tag }}"
          
          echo "Downloading assets for $TAG..."
          gh release download "$TAG" --repo "${{ github.repository }}" --dir release-assets
          
          cd release-assets
          mv "XianYuLauncher_${FULL_VER}_x64.zip" "XianYuLauncher-x64.zip" 2>/dev/null || true
          mv "XianYuLauncher_${FULL_VER}_x86.zip" "XianYuLauncher-x86.zip" 2>/dev/null || true
          mv "XianYuLauncher_${FULL_VER}_arm64.zip" "XianYuLauncher-arm64.zip" 2>/dev/null || true
          ls -lh

      - name: Upload to Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          TAG: ${{ steps.vars.outputs.tag }}
          CHANGELOG: ${{ steps.release.outputs.body }}
        run: |
          OWNER="spiritos"
          REPO="XianYuLauncher-Resource"
          
          echo "Checking if release exists for tag $TAG..."
          RELEASE_CHECK=$(curl -s "https://gitee.com/api/v5/repos/${OWNER}/${REPO}/releases/tags/${TAG}?access_token=${GITEE_TOKEN}")
          echo "Release check response: $RELEASE_CHECK"
          
          if echo "$RELEASE_CHECK" | grep -q '"id"'; then
            RELEASE_ID=$(echo "$RELEASE_CHECK" | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")
            echo "Release exists, ID: $RELEASE_ID"
          else
            echo "Creating new release for tag $TAG..."
            
            TAG_CHECK=$(curl -s "https://gitee.com/api/v5/repos/${OWNER}/${REPO}/tags?access_token=${GITEE_TOKEN}")
            if ! echo "$TAG_CHECK" | grep -q "\"name\":\"${TAG}\""; then
              echo "Tag $TAG does not exist on Gitee, creating it..."
              COMMIT_SHA=$(curl -s "https://gitee.com/api/v5/repos/${OWNER}/${REPO}/branches/main?access_token=${GITEE_TOKEN}" | python3 -c "import sys,json; print(json.load(sys.stdin)['commit']['sha'])")
              echo "Latest commit on main: $COMMIT_SHA"
              
              curl -s -X POST "https://gitee.com/api/v5/repos/${OWNER}/${REPO}/tags" \
                -H "Content-Type: application/json" \
                -d "{\"access_token\": \"${GITEE_TOKEN}\", \"tag_name\": \"${TAG}\", \"refs\": \"${COMMIT_SHA}\"}"
              echo "Tag created."
            fi
            
            CHANGELOG_JSON=$(echo "$CHANGELOG" | python3 -c 'import sys,json; print(json.dumps(sys.stdin.read()))')
            RELEASE_RESP=$(curl -s -X POST "https://gitee.com/api/v5/repos/${OWNER}/${REPO}/releases" \
              -H "Content-Type: application/json" \
              -d "{\"access_token\": \"${GITEE_TOKEN}\", \"tag_name\": \"${TAG}\", \"name\": \"${TAG}\", \"body\": ${CHANGELOG_JSON}, \"prerelease\": false}")
            echo "Create release response: $RELEASE_RESP"
            
            RELEASE_ID=$(echo "$RELEASE_RESP" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('id',''))")
            if [ -z "$RELEASE_ID" ]; then
              echo "ERROR: Failed to create release"
              exit 1
            fi
            echo "Created release, ID: $RELEASE_ID"
          fi
          
          for file in release-assets/*.zip; do
            filename=$(basename "$file")
            filesize=$(du -h "$file" | cut -f1)
            echo "Uploading $filename ($filesize)..."
            UPLOAD_RESP=$(curl --progress-bar -X POST "https://gitee.com/api/v5/repos/${OWNER}/${REPO}/releases/${RELEASE_ID}/attach_files" \
              -F "access_token=${GITEE_TOKEN}" \
              -F "file=@${file}")
            echo ""
            echo "Done: $filename"
          done

      - name: Sync Gitee latest_version.json
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          FULL_VER: ${{ steps.vars.outputs.full_ver }}
          TAG: ${{ steps.vars.outputs.tag }}
          CHANGELOG: ${{ steps.release.outputs.body }}
        run: |
          if [ -z "$GITEE_TOKEN" ]; then
            echo "GITEE_TOKEN is missing." >&2
            exit 1
          fi

          REPO="spiritos/XianYuLauncher-Resource"
          git clone "https://oauth2:${GITEE_TOKEN}@gitee.com/${REPO}.git" gitee-repo
          cd gitee-repo

          python3 << 'PYEOF'
          import json, os
          from datetime import datetime

          path = "latest_version.json"
          with open(path, "r", encoding="utf-8") as f:
              data = json.load(f)

          full_ver = os.environ.get("FULL_VER")
          tag = os.environ.get("TAG")
          changelog = os.environ.get("CHANGELOG", "")

          data["version"] = full_ver
          data["release_time"] = datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")

          if changelog:
              data["changelog"] = [line.strip() for line in changelog.split("\n") if line.strip()]
          
          base_url = f"https://gitee.com/spiritos/XianYuLauncher-Resource/releases/download/{tag}"
          github_base = f"https://github.com/N123999/XianYuLauncher/releases/download/{tag}"
          
          data["download_mirrors"] = [
              {
                  "name": "Gitee",
                  "url": f"{base_url}/XianYuLauncher-x64.zip",
                  "arch_urls": {
                      "x64": f"{base_url}/XianYuLauncher-x64.zip",
                      "x86": f"{base_url}/XianYuLauncher-x86.zip",
                      "arm64": f"{base_url}/XianYuLauncher-arm64.zip"
                  }
              },
              {
                  "name": "GitHub",
                  "url": f"{github_base}/XianYuLauncher_{full_ver}_x64.zip",
                  "arch_urls": {
                      "x64": f"{github_base}/XianYuLauncher_{full_ver}_x64.zip",
                      "x86": f"{github_base}/XianYuLauncher_{full_ver}_x86.zip",
                      "arm64": f"{github_base}/XianYuLauncher_{full_ver}_arm64.zip"
                  }
              }
          ]

          with open(path, "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          
          print(f"Updated: version={full_ver}, tag={tag}")
          PYEOF

          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add latest_version.json
          git commit -m "chore: update version to $FULL_VER" || echo "No changes"
          git push
