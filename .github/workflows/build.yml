name: Build and Release XianYuLauncher

on:
  push:
    branches: [ "main" ]
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      Solution_Name: XianYuLauncher.slnx
      Project_Path: XianYuLauncher/XianYuLauncher.csproj
      Configuration: Release
      Platform: x64
      # 用于签名的临时文件名
      Certificate_Path: GitHubActionsWorkflow.pfx

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 1. 配置 MSBuild
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    # 1.5. 安装 .NET 10 (WinUI3 需要)
    - name: Install .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    # 2. 还原 secrets.json
    - name: Restore secrets.json
      shell: powershell
      run: |
        $secretJson = '${{ secrets.APP_SECRETS_JSON }}'
        if ([string]::IsNullOrWhiteSpace($secretJson)) {
            Write-Warning "APP_SECRETS_JSON is possibly empty or not set."
        }
        # 确保目录存在
        New-Item -ItemType Directory -Force -Path XianYuLauncher | Out-Null
        $secretJson | Out-File -FilePath XianYuLauncher/secrets.json -Encoding utf8
        Write-Host "secrets.json restored."

    # 3. 准备证书
    - name: Prepare Certificate
      shell: powershell
      run: |
        $pfxBase64 = '${{ secrets.PFX_BASE64 }}'
        if ([string]::IsNullOrWhiteSpace($pfxBase64)) {
            Write-Error "Secret PFX_BASE64 missing"
            exit 1
        }
        $pfxPath = "$env:GITHUB_WORKSPACE\sign.pfx"
        $pfxBytes = [System.Convert]::FromBase64String($pfxBase64)
        [System.IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
        
        echo "CERT_PATH=$pfxPath" >> $env:GITHUB_ENV
        Write-Host "Cert saved to $pfxPath"

    # 4. 更新版本号 (仅Tag)
    - name: Update Version
      if: startsWith(github.ref, 'refs/tags/v')
      shell: powershell
      run: |
        $tag = "${{ github.ref_name }}".Substring(1)
        if ($tag -match '^\d+\.\d+\.\d+$') { $tag = "$tag.0" }
        Write-Host "Version: $tag"
        
        $manifest = "XianYuLauncher/Package.appxmanifest"
        [xml]$xml = Get-Content $manifest
        $xml.Package.Identity.Version = $tag
        $xml.Save($manifest)

    # 5. 还原包
    - name: Restore
      run: nuget restore ${{ env.Solution_Name }}

    # 6. 打包
    - name: Build
      shell: powershell
      run: |
        msbuild ${{ env.Project_Path }} `
          /p:Configuration=${{ env.Configuration }} `
          /p:Platform=${{ env.Platform }} `
          /p:UapAppxPackageBuildMode=SideloadOnly `
          /p:AppxBundle=Never `
          /p:AppxPackageSigningEnabled=true `
          /p:PackageCertificateKeyFile="${{ env.CERT_PATH }}" `
          /p:PackageCertificatePassword="${{ secrets.PFX_PASSWORD }}" `
          /p:AppxPackageDir="$env:GITHUB_WORKSPACE\AppPackages" `
          /p:GenerateAppInstallerFile=true `
          /p:AppInstallerUri="https://github.com/XianYuLauncher/XianYuLauncher/releases/latest/download/"
          
    # 7. 上传
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: XianYuLauncher-Build
        path: AppPackages/**/*.msix*

    # 8. 发布 (仅Tag)
    - name: Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          AppPackages/**/*.msix
          AppPackages/**/*.cer
          AppPackages/**/*.appinstaller
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') }}
