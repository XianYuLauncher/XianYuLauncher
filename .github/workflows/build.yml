name: Build and Release XianYuLauncher

on:
  push:
    branches: [ "main" ]
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        platform: [x86, x64, arm64]
    
    runs-on: windows-latest

    env:
      Solution_Name: XianYuLauncher.slnx
      Project_Path: XianYuLauncher/XianYuLauncher.csproj
      Configuration: Release
      Platform: ${{ matrix.platform }}
      # 用于签名的临时文件名
      Certificate_Path: GitHubActionsWorkflow.pfx

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 1. 配置 MSBuild
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    # 1.5. 安装 .NET 10 (WinUI3 需要)
    - name: Install .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    # 2. 还原 secrets.json
    - name: Restore secrets.json
      shell: powershell
      run: |
        $secretJson = '${{ secrets.APP_SECRETS_JSON }}'
        if ([string]::IsNullOrWhiteSpace($secretJson)) {
            Write-Warning "APP_SECRETS_JSON is possibly empty or not set."
        }
        # 确保目录存在
        New-Item -ItemType Directory -Force -Path XianYuLauncher | Out-Null
        $secretJson | Out-File -FilePath XianYuLauncher/secrets.json -Encoding utf8
        Write-Host "secrets.json restored."

    # 3. 准备证书 (Base64 -> PFX)
    - name: Prepare Certificate
      shell: powershell
      run: |
        $pfxBase64 = '${{ secrets.PFX_BASE64 }}'
        if ([string]::IsNullOrWhiteSpace($pfxBase64)) {
            Write-Error "Secret PFX_BASE64 missing"
            exit 1
        }
        $pfxPath = "$env:GITHUB_WORKSPACE\sign.pfx"
        $pfxBytes = [System.Convert]::FromBase64String($pfxBase64)
        [System.IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
        
        Write-Host "Cert saved to $pfxPath"
        
        # 显式导入证书并获取 Thumbprint
        $password = ConvertTo-SecureString -String '${{ secrets.PFX_PASSWORD }}' -AsPlainText -Force
        $cert = Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\CurrentUser\My -Password $password
        
        echo "PFX_THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV
        Write-Host "Imported certificate with Thumbprint: $($cert.Thumbprint)"

    # 4. 根据 Tag 判断通道并修改 Manifest (Dev/Stable)
    - name: Configure Channel
      shell: powershell
      run: |
        $refName = "${{ github.ref_name }}"
        $manifestPath = "XianYuLauncher/Package.appxmanifest"
        [xml]$xml = Get-Content $manifestPath
        
        # 默认先把版本号提取出来 (去掉 v)
        $version = $refName
        if ($version.StartsWith("v")) { $version = $version.Substring(1) }
        # 提取基础版本号 (例如 1.4.0)
        if ($version -match '^(\d+\.\d+\.\d+)(.*)$') { 
            $baseVer = $matches[1]
            $suffix = $matches[2]
            
            # 默认 Revision 为 0
            $revision = 0
            
            # 尝试从后缀中提取数字作为 Revision
            # 例如: -dev1 -> 1, -beta05 -> 5
            if ($suffix -match '(\d+)$') {
                $revision = [int]$matches[1]
            }
            
            # 组合成 MSIX 需要的四段式 (Major.Minor.Build.Revision)
            $cleanVer = "$baseVer.$revision"
            
            $xml.Package.Identity.Version = $cleanVer
            Write-Host "Set Package Version: $cleanVer (Base: $baseVer, Rev: $revision)"
        }

        # 判断是否为 Dev/Beta 通道 (包含 -dev, -beta 或非 Tag 触发)
        # 这里逻辑：只要 Tag 里带 '-' (如 v1.4.0-dev)，或者干脆不是 v开头的 Tag，都算 Dev
        if ($refName -match '-' -or -not ($refName -match '^v\d')) {
            Write-Host "Channel: DEV/BETA"
            
            # 1. 修改包名 (Identity Name)
            $oldName = $xml.Package.Identity.Name
            $xml.Package.Identity.Name = "$oldName.Dev"
            Write-Host "Updated Identity Name: $oldName -> $($xml.Package.Identity.Name)"
            
            # 2. 修改显示名称 (DisplayName)
            # 注意: ms-resource: 是资源引用，不支持直接加后缀，需要直接改原始 manifest 里的字符串值
            # 如果原始值是 ms-resource:AppDisplayName，必须保留，但这里我们无法轻易修改 PRI 资源表
            # 临时方案: 直接硬编码显示名称，绕过资源引用 (仅用于 Dev)
            $xml.Package.Properties.DisplayName = "XianYu Launcher (Dev)"
            
            # 同时修改 VisualElements 里的名称
            if ($xml.Package.Applications.Application.VisualElements) {
                # 同理，硬编码名称
                $xml.Package.Applications.Application.VisualElements.DisplayName = "XianYu Launcher (Dev)"
            }
            
            # 3. 替换图标 (Assets/Dev 下的所有文件覆盖到 Assets)
            $devAssetsPath = "XianYuLauncher/Assets/Dev"
            $targetAssetsPath = "XianYuLauncher/Assets"
            
            if (Test-Path $devAssetsPath) {
                Get-ChildItem -Path $devAssetsPath -File | ForEach-Object {
                    $dest = Join-Path $targetAssetsPath $_.Name
                    Copy-Item $_.FullName $dest -Force
                    Write-Host "Replaced Asset: $($_.Name)"
                }
            } else {
                Write-Warning "Dev assets directory not found at $devAssetsPath"
            }
            
            # 4. 设置编译宏 (供 C# 代码使用)
            echo "Build_Constants=DEV_CHANNEL" >> $env:GITHUB_ENV
        } else {
            Write-Host "Channel: STABLE"
            # Stable 不需要改 Manifest，保持原样
            echo "Build_Constants=RELEASE_CHANNEL" >> $env:GITHUB_ENV
        }
        
        $xml.Save($manifestPath)

    # 5. 还原包
    - name: Restore
      run: nuget restore ${{ env.Solution_Name }}

    # 6. 构建并打包 (使用 MSBuild)
    - name: Build
      shell: powershell
      run: |
        msbuild ${{ env.Project_Path }} `
          /p:Configuration=${{ env.Configuration }} `
          /p:Platform=${{ env.Platform }} `
          /p:DefineConstants="${{ env.Build_Constants }}" `
          /p:GenerateAppxPackageOnBuild=true `
          /p:UapAppxPackageBuildMode=SideloadOnly `
          /p:AppxBundle=Never `
          /p:AppxPackageSigningEnabled=true `
          /p:PackageCertificateThumbprint="${{ env.PFX_THUMBPRINT }}" `
          /p:AppxPackageDir="$env:GITHUB_WORKSPACE\AppPackages\" `
          /p:PackageOutputPath="$env:GITHUB_WORKSPACE\AppPackages\" `
          /p:GenerateAppInstallerFile=false

    # 7. 重命名并打包 Zip (去除 _Test 后缀)
    - name: Rename and Zip
      shell: powershell
      run: |
        $sourceDir = "${{ github.workspace }}\AppPackages"
        $dirs = Get-ChildItem -Path $sourceDir -Directory -Filter "*_Test"
        
        foreach ($dir in $dirs) {
            # 新名称：去掉 _Test 后缀
            $newName = $dir.Name -replace "_Test$", ""
            $zipPath = Join-Path $sourceDir "$newName.zip"
            
            Write-Host "Zipping $($dir.FullName) to $zipPath"
            
            # 使用 Compress-Archive 打包目录内容
            Compress-Archive -Path "$($dir.FullName)\*" -DestinationPath $zipPath -Force
        }

    # 8. 上传 Artifact (Zip文件)
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Package-${{ matrix.platform }}
        path: ${{ github.workspace }}\AppPackages\*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Display structure of downloaded files
      run: ls -R artifacts

    # 1. 生成更新日志 (提前到部署前)
    - name: Build Changelog
      id: build_changelog
      uses: mikepenz/release-changelog-builder-action@v4
      with:
        configuration: ".github/changelog-configuration.json"
        ignorePreReleases: ${{ !contains(github.ref, 'beta') && !contains(github.ref, 'dev') }}

    # 2. 发布 Release (只上传标准带版本号的文件，保持干净)
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        body: ${{ steps.build_changelog.outputs.changelog }}
        files: artifacts/**/*.zip
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'dev') }}

    # 3. 触发服务器下载 (仅限正式版)
    - name: Trigger Server Pull
      if: ${{ !contains(github.ref, 'beta') && !contains(github.ref, 'dev') }}
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script_stop: true
        timeout: 120s
        command_timeout: 180m
        script: |
          # 定义目标目录
          TARGET_DIR="/www/wwwroot/spiritstudio.com.cn/files/XianYuLauncher"
          mkdir -p $TARGET_DIR
          cd $TARGET_DIR
          
          # 计算版本号: v1.4.2 -> 1.4.2 -> 1.4.2.0
          VER_TAG="${{ github.ref_name }}"
          VER_NUM="${VER_TAG#v}"
          FULL_VER="${VER_NUM}.0"
          
          echo "Processing version: $FULL_VER"
          
          # 构造下载链接 (GitHub 官方源)
          URL_PREFIX="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}"
          
          # 下载并重命名为固定文件名 (覆盖旧文件)
          echo "Pulling x64..."
          wget -O XianYuLauncher-x64.zip "$URL_PREFIX/XianYuLauncher_${FULL_VER}_x64.zip"
          
          echo "Pulling x86..."
          wget -O XianYuLauncher-x86.zip "$URL_PREFIX/XianYuLauncher_${FULL_VER}_x86.zip"
          
          echo "Pulling arm64..."
          wget -O XianYuLauncher-arm64.zip "$URL_PREFIX/XianYuLauncher_${FULL_VER}_arm64.zip"
          
          ls -lh

